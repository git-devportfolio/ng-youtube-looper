<form [formGroup]="loopForm" (ngSubmit)="onSubmit()" class="loop-form">
  <div class="form-header">
    <h3 class="form-title">{{ formTitle }}</h3>
  </div>

  <div class="form-body">
    <!-- Nom de la boucle -->
    <div class="form-group">
      <label for="name" class="form-label">Nom de la boucle</label>
      <input
        type="text"
        id="name"
        formControlName="name"
        class="form-input"
        [class.error]="nameControl?.invalid && nameControl?.touched"
        placeholder="Ex: Solo guitare"
      />
      @if (nameControl?.invalid && nameControl?.touched) {
        <span class="error-message">{{ getNameErrorMessage() }}</span>
      }
    </div>

    <!-- Temps de d√©but et fin -->
    <div class="time-inputs-group">
      <div class="form-group half-width">
        <label for="startTime" class="form-label">D√©but</label>
        <div class="time-input-container">
          <input
            type="text"
            id="startTime"
            formControlName="startTimeText"
            class="form-input time-input"
            [class.error]="startTimeControl?.invalid && startTimeControl?.touched"
            placeholder="0:00"
          />
          <button
            type="button"
            class="current-time-btn"
            [disabled]="!canUseCurrentTime"
            (click)="setCurrentTimeAsStart()"
            [attr.title]="canUseCurrentTime ? 'Utiliser temps actuel (' + currentTimeDisplay + ')' : 'Pas de vid√©o en lecture'"
            [attr.aria-label]="'D√©finir le temps de d√©but au temps actuel'"
          >
            <span class="btn-icon" aria-hidden="true">üïê</span>
          </button>
        </div>
        @if (startTimeControl?.invalid && startTimeControl?.touched) {
          <span class="error-message">{{ getStartTimeErrorMessage() }}</span>
        }
      </div>

      <div class="form-group half-width">
        <label for="endTime" class="form-label">Fin</label>
        <div class="time-input-container">
          <input
            type="text"
            id="endTime"
            formControlName="endTimeText"
            class="form-input time-input"
            [class.error]="endTimeControl?.invalid && endTimeControl?.touched"
            placeholder="0:30"
          />
          <button
            type="button"
            class="current-time-btn"
            [disabled]="!canUseCurrentTime"
            (click)="setCurrentTimeAsEnd()"
            [attr.title]="canUseCurrentTime ? 'Utiliser temps actuel (' + currentTimeDisplay + ')' : 'Pas de vid√©o en lecture'"
            [attr.aria-label]="'D√©finir le temps de fin au temps actuel'"
          >
            <span class="btn-icon" aria-hidden="true">üïê</span>
          </button>
        </div>
        @if (endTimeControl?.invalid && endTimeControl?.touched) {
          <span class="error-message">{{ getEndTimeErrorMessage() }}</span>
        }
      </div>
    </div>

    <!-- Segment Preview Timeline -->
    @if (videoDuration && videoDuration > 0) {
      <div class="form-group">
        <label class="form-label">Pr√©visualisation du segment</label>
        <div class="segment-preview">
          <div class="timeline-container">
            <!-- Video duration bar -->
            <div class="video-timeline">
              <!-- Selected segment highlight -->
              <div 
                class="segment-highlight"
                [style.left.%]="getSegmentStartPercent()"
                [style.width.%]="getSegmentWidthPercent()"
                [class.valid]="isSegmentValid()"
                [class.invalid]="!isSegmentValid()"
              ></div>
              
              <!-- Time markers -->
              <div class="time-markers">
                <div class="marker start-marker" [style.left.%]="getSegmentStartPercent()">
                  <div class="marker-line"></div>
                  <div class="marker-label">{{ getStartTimeDisplay() }}</div>
                </div>
                <div class="marker end-marker" [style.left.%]="getSegmentEndPercent()">
                  <div class="marker-line"></div>
                  <div class="marker-label">{{ getEndTimeDisplay() }}</div>
                </div>
              </div>
            </div>
            
            <!-- Timeline labels -->
            <div class="timeline-labels">
              <span class="start-label">0:00</span>
              <span class="duration-info">
                Dur√©e: {{ getSegmentDurationDisplay() }}
              </span>
              <span class="end-label">{{ formatVideoDuration() }}</span>
            </div>
          </div>
          
          <!-- Preview info -->
          <div class="preview-info">
            @if (!isSegmentValid()) {
              <div class="validation-warning" role="alert">
                <span class="warning-icon" aria-hidden="true">‚ö†Ô∏è</span>
                <span class="warning-text">
                  @if (getSegmentValidationError()) {
                    {{ getSegmentValidationError() }}
                  }
                </span>
              </div>
            } @else {
              <div class="segment-stats">
                <span class="stat">
                  <strong>D√©but:</strong> {{ getStartTimeDisplay() }}
                </span>
                <span class="stat">
                  <strong>Fin:</strong> {{ getEndTimeDisplay() }}
                </span>
                <span class="stat">
                  <strong>Dur√©e:</strong> {{ getSegmentDurationDisplay() }}
                </span>
              </div>
            }
          </div>
        </div>
      </div>
    }

    <!-- Vitesse de lecture -->
    <div class="form-group">
      <label for="playbackSpeed" class="form-label">Vitesse de lecture</label>
      <select
        id="playbackSpeed"
        formControlName="playbackSpeed"
        class="form-select"
        [class.error]="playbackSpeedControl?.invalid && playbackSpeedControl?.touched"
      >
        @for (option of speedOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>

    <!-- Nombre de r√©p√©titions -->
    <div class="form-group">
      <label for="repeatCount" class="form-label">R√©p√©titions</label>
      <input
        type="number"
        id="repeatCount"
        formControlName="repeatCount"
        class="form-input"
        [class.error]="repeatCountControl?.invalid && repeatCountControl?.touched"
        min="1"
        max="100"
      />
      @if (repeatCountControl?.invalid && repeatCountControl?.touched) {
        <span class="error-message">Le nombre de r√©p√©titions doit √™tre entre 1 et 100</span>
      }
    </div>

    <!-- Couleur -->
    <div class="form-group">
      <label for="color" class="form-label">Couleur</label>
      <div class="color-selector">
        @for (colorOption of colorOptions; track colorOption.value) {
          <button
            type="button"
            class="color-option"
            [class.selected]="colorControl?.value === colorOption.value"
            [style.background-color]="colorOption.value"
            (click)="colorControl?.setValue(colorOption.value)"
            [attr.aria-label]="colorOption.label"
          >
            @if (colorControl?.value === colorOption.value) {
              <span class="color-checkmark">‚úì</span>
            }
          </button>
        }
      </div>
    </div>

    <!-- Erreurs g√©n√©rales du formulaire -->
    @if (loopForm.invalid && loopForm.touched) {
      <div class="form-errors">
        @if (getFormErrorMessage()) {
          <span class="error-message">{{ getFormErrorMessage() }}</span>
        }
      </div>
    }
  </div>

  <div class="form-footer">
    <button
      type="button"
      class="btn btn-secondary"
      (click)="onCancel()"
    >
      Annuler
    </button>
    
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="loopForm.invalid"
    >
      {{ isEditMode ? 'Modifier' : 'Cr√©er' }}
    </button>
  </div>
</form>

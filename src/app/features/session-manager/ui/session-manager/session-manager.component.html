<div class="session-manager-container">
  
  <!-- Header Section -->
  <div class="manager-header">
    <div class="header-content">
      
      <!-- Navigation and Title -->
      <div class="header-navigation">
        @if (showBackButton()) {
          <button 
            class="back-btn"
            (click)="navigateBack()"
            aria-label="Retour √† la liste des sessions"
            type="button">
            <span class="back-icon">‚Üê</span>
            Retour
          </button>
        }
        
        <h1 class="manager-title">{{ viewTitle() }}</h1>
      </div>

      <!-- Header Actions -->
      <div class="header-actions">
        @if (currentView() === 'list') {
          <!-- List View Actions -->
          <div class="list-actions">
            @if (canCreateSession()) {
              <button 
                class="action-btn primary"
                (click)="navigateToCreate()"
                aria-label="Cr√©er une nouvelle session"
                type="button">
                <span class="btn-icon">‚ûï</span>
                Nouvelle Session
              </button>
            }
            
            <div class="view-toggle-group">
              <button 
                class="view-toggle"
                [class.active]="currentView() === 'list'"
                (click)="navigateToView('list')"
                aria-label="Afficher les sessions"
                type="button">
                <span class="toggle-icon">üìã</span>
                Sessions
              </button>
              
              <button 
                class="view-toggle"
                [class.active]="currentView() === 'history'"
                (click)="navigateToView('history')"
                aria-label="Afficher l'historique"
                type="button">
                <span class="toggle-icon">üìö</span>
                Historique
              </button>
              
              <button 
                class="view-toggle"
                [class.active]="currentView() === 'import-export'"
                (click)="navigateToView('import-export')"
                aria-label="Import/Export de sessions"
                type="button">
                <span class="toggle-icon">üîÑ</span>
                Import/Export
              </button>
            </div>
          </div>
        }

        <!-- Bulk Selection Actions -->
        @if (currentView() === 'list' && hasSelectedSessions()) {
          <div class="bulk-actions">
            <div class="selection-info">
              {{ getSelectedCount() }} s√©lectionn√©e{{ getSelectedCount() !== 1 ? 's' : '' }}
            </div>
            
            <div class="bulk-buttons">
              <button 
                class="bulk-btn export"
                (click)="exportSelectedSessions()"
                [attr.aria-label]="'Exporter ' + getSelectedCount() + ' sessions'"
                type="button">
                <span class="btn-icon">üì§</span>
                Exporter
              </button>
              
              <button 
                class="bulk-btn delete"
                (click)="deleteSelectedSessions()"
                [attr.aria-label]="'Supprimer ' + getSelectedCount() + ' sessions'"
                type="button">
                <span class="btn-icon">üóëÔ∏è</span>
                Supprimer
              </button>
              
              <button 
                class="bulk-btn clear"
                (click)="clearSelectedSessions()"
                aria-label="D√©s√©lectionner toutes les sessions"
                type="button">
                <span class="btn-icon">‚úï</span>
                Effacer
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="manager-content">
    
    <!-- Session List View -->
    @if (currentView() === 'list') {
      <div class="list-view">
        <app-session-list
          [showSearch]="true"
          [showVideoFilter]="false"
          [maxDisplayCount]="50"
          (sessionSelect)="onSessionSelect($event)"
          (sessionLoad)="onSessionLoad($event)"
          (sessionEdit)="onSessionEdit($event)"
          (sessionDelete)="onSessionDelete($event)"
          (sessionDuplicate)="onSessionDuplicate($event)"
          (createSession)="onCreateSessionRequest()"
          (importSessions)="onImportSessionsRequest()">
        </app-session-list>
        
        <!-- Quick Actions Panel -->
        @if (sessionList().length > 0) {
          <div class="quick-actions-panel">
            <h3 class="panel-title">Actions rapides</h3>
            
            <div class="quick-actions">
              <button 
                class="quick-action-btn"
                (click)="selectAllSessions()"
                type="button">
                <span class="action-icon">‚òëÔ∏è</span>
                Tout s√©lectionner
              </button>
              
              <button 
                class="quick-action-btn"
                (click)="navigateToView('import-export')"
                type="button">
                <span class="action-icon">üì§</span>
                Exporter tout
              </button>
              
              <button 
                class="quick-action-btn"
                (click)="navigateToView('history')"
                type="button">
                <span class="action-icon">üìö</span>
                Voir l'historique
              </button>
            </div>
          </div>
        }
      </div>
    }

    <!-- Session Form Views (Create/Edit) -->
    @if (currentView() === 'create' || currentView() === 'edit') {
      <div class="form-view">
        <app-session-form
          [session]="currentView() === 'edit' ? editingSession() : null"
          [videoId]="videoContext()?.videoId || null"
          [videoTitle]="videoContext()?.videoTitle || null"
          [videoUrl]="videoContext()?.videoUrl || null"
          [videoDuration]="videoContext()?.videoDuration || null"
          (save)="onSessionSave($event)"
          (cancel)="onSessionCancel()">
        </app-session-form>
      </div>
    }

    <!-- History View -->
    @if (currentView() === 'history') {
      <div class="history-view">
        
        <!-- Recent Sessions Header -->
        <div class="history-section">
          <h2 class="history-title">
            <span class="history-icon">üïí</span>
            Sessions r√©centes
          </h2>
          
          @if (recentSessions().length === 0) {
            <div class="empty-history">
              <div class="empty-icon">üì≠</div>
              <h3 class="empty-title">Aucun historique</h3>
              <p class="empty-description">
                L'historique s'affichera ici quand vous commencerez √† utiliser des sessions.
              </p>
            </div>
          }
        </div>

        <!-- Recent Videos from History -->
        @if (recentVideos().length > 0) {
          <div class="recent-videos">
            <h3 class="section-subtitle">Derni√®res vid√©os utilis√©es</h3>
            
            <div class="video-history-list">
              @for (entry of recentVideos(); track trackHistoryById($index, entry)) {
                <div class="history-item"
                     tabindex="0"
                     role="button"
                     [attr.aria-label]="'Vid√©o ' + entry.videoTitle + ', derni√®re utilisation ' + formatRelativeDate(entry.accessedAt)">
                  
                  <div class="history-item-content">
                    <div class="video-info">
                      <h4 class="video-title">{{ entry.videoTitle }}</h4>
                      <div class="video-meta">
                        <span class="session-name">{{ entry.sessionName }}</span>
                        <span class="access-time">{{ formatRelativeDate(entry.accessedAt) }}</span>
                      </div>
                    </div>
                    
                    <div class="history-stats">
                      @if (entry.loopsCount > 0) {
                        <div class="stat">
                          <span class="stat-icon">üîÑ</span>
                          <span class="stat-value">{{ entry.loopsCount }}</span>
                        </div>
                      }
                      @if (entry.duration > 0) {
                        <div class="stat">
                          <span class="stat-icon">‚è±Ô∏è</span>
                          <span class="stat-value">{{ formatDuration(entry.duration) }}</span>
                        </div>
                      }
                    </div>
                  </div>
                  
                  <div class="history-actions">
                    <button 
                      class="history-btn load"
                      (click)="loadSessionFromHistory(entry)"
                      [attr.aria-label]="'Charger la session ' + entry.sessionName"
                      type="button">
                      <span class="btn-icon">‚ñ∂Ô∏è</span>
                      Charger
                    </button>
                    
                    <button 
                      class="history-btn create"
                      (click)="createSessionFromHistory(entry)"
                      [attr.aria-label]="'Cr√©er une nouvelle session pour ' + entry.videoTitle"
                      type="button">
                      <span class="btn-icon">‚ûï</span>
                      Nouvelle
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Import/Export View -->
    @if (currentView() === 'import-export') {
      <div class="import-export-view">
        <app-import-export
          [selectedSessions]="selectedSessions()"
          [showBulkExport]="true"
          [showImport]="true"
          (exportComplete)="onExportComplete($event)"
          (importComplete)="onImportComplete($event)"
          (operationError)="onOperationError($event)">
        </app-import-export>
      </div>
    }
  </div>

  <!-- Auto-save Status Bar -->
  @if (currentSession() && (sessionFacade.autoSaveStatus() !== 'idle' || sessionFacade.saveError())) {
    <div class="auto-save-status-bar">
      <div class="save-status-content">
        <!-- Save Status Indicator -->
        <div class="save-status-indicator" 
             [class]="'status-' + sessionFacade.autoSaveStatus()"
             [attr.aria-live]="sessionFacade.autoSaveStatus() === 'saving' ? 'polite' : 'off'">
          
          @switch (sessionFacade.autoSaveStatus()) {
            @case ('saving') {
              <div class="status-spinner auto-save"></div>
              <span class="status-text">{{ sessionFacade.saveStatusText() }}</span>
            }
            @case ('saved') {
              <span class="status-icon success">‚úì</span>
              <span class="status-text">{{ sessionFacade.saveStatusText() }}</span>
            }
            @case ('pending') {
              <span class="status-icon pending">‚óè</span>
              <span class="status-text">{{ sessionFacade.saveStatusText() }}</span>
            }
            @case ('error') {
              <span class="status-icon error">‚ö†Ô∏è</span>
              <span class="status-text">{{ sessionFacade.saveStatusText() }}</span>
            }
          }
        </div>

        <!-- Auto-save Actions -->
        <div class="save-actions">
          @if (sessionFacade.canManualSave()) {
            <button 
              class="save-btn manual"
              (click)="onManualSave()"
              [disabled]="sessionFacade.isSaving()"
              aria-label="Sauvegarder manuellement"
              type="button">
              <span class="btn-icon">üíæ</span>
              Sauvegarder
            </button>
          }

          @if (sessionFacade.saveError()) {
            <button 
              class="save-btn retry"
              (click)="onRetrySave()"
              [disabled]="sessionFacade.isSaving()"
              aria-label="R√©essayer la sauvegarde"
              type="button">
              <span class="btn-icon">üîÑ</span>
              R√©essayer
            </button>

            <button 
              class="save-btn dismiss"
              (click)="onDismissError()"
              aria-label="Ignorer l'erreur"
              type="button">
              <span class="btn-icon">‚úï</span>
            </button>
          }

          <!-- Auto-save Toggle -->
          <button 
            class="save-btn toggle"
            [class.active]="sessionFacade.settings().autoSaveEnabled"
            (click)="onToggleAutoSave()"
            [attr.aria-label]="sessionFacade.settings().autoSaveEnabled ? 'D√©sactiver la sauvegarde automatique' : 'Activer la sauvegarde automatique'"
            type="button">
            <span class="btn-icon">‚öôÔ∏è</span>
            Auto-save {{ sessionFacade.settings().autoSaveEnabled ? 'ON' : 'OFF' }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- General Status Bar -->
  @if (isLoading() || lastError()) {
    <div class="status-bar">
      @if (isLoading()) {
        <div class="status-item loading">
          <div class="status-spinner"></div>
          <span class="status-text">Chargement...</span>
        </div>
      }
      
      @if (lastError(); as error) {
        <div class="status-item error" role="alert">
          <span class="status-icon">‚ö†Ô∏è</span>
          <span class="status-text">{{ error }}</span>
        </div>
      }
    </div>
  }
</div>
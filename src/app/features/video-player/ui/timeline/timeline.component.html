<div [class]="getContainerClasses()" role="region" [attr.aria-label]="'Timeline de la vidéo avec ' + effectiveLoops.length + ' boucle' + (effectiveLoops.length > 1 ? 's' : '')">
  
  <!-- Live region for timeline announcements -->
  <div class="sr-only" aria-live="polite" aria-atomic="true" id="timeline-announcements"></div>
  
  <!-- Timeline Track -->
  <div id="timeline" 
       class="timeline-track"
       tabindex="-1"
       [class.creating]="isCreatingLoop"
       [class.has-collision]="creationHasCollision"
       (click)="onTrackClick($event)"
       (dblclick)="onTrackDoubleClick($event)"
       (mousedown)="onTrackMouseDown($event)"
       (keydown)="onKeyDown($event)"
       (touchstart)="onTouchStart($event)"
       (touchend)="onTouchEnd($event)"
       [style.cursor]="isReady ? (isCreatingLoop ? 'grabbing' : canCreateLoops ? 'crosshair' : 'pointer') : 'default'"
       tabindex="0"
       role="slider"
       [attr.aria-valuemin]="0"
       [attr.aria-valuemax]="duration"
       [attr.aria-valuenow]="currentTime"
       [attr.aria-label]="'Timeline scrubber - Current time: ' + formatDuration(currentTime) + ' of ' + formatDuration(duration) + (canCreateLoops ? '. Double-click or drag to create loop, Ctrl+L to create at current time' : '') + '. Use arrow keys to navigate, Enter/Space to select'"
       [attr.aria-roledescription]="'Contrôleur de timeline vidéo'"
       [attr.aria-describedby]="'timeline-help'">>
    
    <!-- Enhanced Background Track with Visual Guides -->
    <div class="track-background">
      <!-- Magnetic guides visualization -->
      @if (shouldShowMagneticGuides) {
        @for (guidePosition of getMagneticGuidePositions(); track trackGuideByPosition($index, guidePosition)) {
          <div class="magnetic-guide"
               [style.left.%]="guidePosition"
               [class.active]="activeMagneticGuide !== null && getPositionForTime(activeMagneticGuide!) === guidePosition"
               [attr.aria-hidden]="true">
          </div>
        }
      }
      
      <!-- Progress indicators for video sections -->
      <div class="section-indicators">
        @if (duration > 60) {
          @for (marker of getTimeMarkers(); track trackMarkerByPosition($index, marker)) {
            <div class="time-marker"
                 [style.left.%]="marker.position"
                 [attr.title]="marker.label">
              <span class="marker-label">{{ marker.shortLabel }}</span>
            </div>
          }
        }
      </div>
    </div>
    
    <!-- Current Time Indicator Container -->
    <div class="current-time-indicator-container">
      <!-- Current Time Indicator with enhanced states -->
      <div class="current-time-indicator"
           [class]="indicatorClasses"
           [style.left.%]="currentTimePercentage"
           [attr.aria-label]="'Position: ' + formatDuration(currentTime)">
        <div class="indicator-circle"></div>
        <div class="indicator-line"></div>
      </div>
    </div>
    
    <!-- Loop Creation Preview -->
    @if (creationPreview && getCreationPreviewPosition()) {
      <div class="creation-preview"
           [class.has-collision]="creationHasCollision"
           [style.left.%]="getCreationPreviewPosition()!.left"
           [style.width.%]="getCreationPreviewPosition()!.width"
           [attr.aria-label]="'Creating loop from ' + formatDuration(creationPreview.startTime) + ' to ' + formatDuration(creationPreview.endTime)">
        <div class="preview-body">
          <div class="preview-times">
            <span class="start-time">{{ formatDuration(creationPreview.startTime) }}</span>
            <span class="end-time">{{ formatDuration(creationPreview.endTime) }}</span>
          </div>
          <div class="preview-duration">{{ formatDuration(creationPreview.endTime - creationPreview.startTime) }}</div>
        </div>
        @if (creationHasCollision) {
          <div class="collision-warning">⚠</div>
        }
      </div>
    }
    
    <!-- Loop Segments Container -->
    <div class="loop-segments-container">
      @for (loop of effectiveLoops; track trackLoopById($index, loop); let i = $index) {
        <div [class]="getEnhancedLoopClasses(loop)"
             [attr.data-loop-id]="loop.id"
             [style.left.%]="getLoopPosition(loop).left"
             [style.width.%]="getLoopPosition(loop).width"
             [style.--loop-index]="i"
             [style.--loop-color]="getLoopColor(loop)"
             [style.animation-delay]="getLoopAnimationDelay(i)"
             (click)="onLoopClick($event, loop)"
             (mouseenter)="onLoopMouseEnter(loop)"
             (mouseleave)="onLoopMouseLeave(loop)"
             tabindex="0"
             role="button"
             [attr.aria-pressed]="selectedLoopId === loop.id"
             [attr.aria-label]="'Loop segment' + (loop.name ? ' ' + loop.name : '') + ' from ' + formatDuration(loop.startTime) + ' to ' + formatDuration(loop.endTime) + (selectedLoopId === loop.id ? ', sélectionnée' : '') + (isLoopPlaying(loop) ? ', en cours de lecture' : '')"
             [attr.aria-roledescription]="'Segment de boucle vidéo'"
             [attr.aria-describedby]="'loop-actions-help'">
          
          <!-- Enhanced tooltip -->
          <div class="loop-tooltip"
               [class.visible]="shouldShowTooltip(loop)"
               [attr.aria-hidden]="true">
            <div class="tooltip-content">
              <div class="tooltip-header">
                <span class="loop-name">{{ loop.name || 'Loop ' + loop.id }}</span>
                <span class="loop-duration">{{ formatDuration(loop.endTime - loop.startTime) }}</span>
              </div>
              <div class="tooltip-times">
                <span class="time-range">
                  {{ formatDuration(loop.startTime) }} → {{ formatDuration(loop.endTime) }}
                </span>
              </div>
              @if (getLoopStats(loop); as stats) {
                <div class="tooltip-stats">
                  <span class="play-count" *ngIf="stats.playCount > 0">{{ stats.playCount }} plays</span>
                  <span class="collision-status" *ngIf="stats.hasNearbyCollisions">Near collision</span>
                </div>
              }
            </div>
          </div>
          
          <!-- Left resize handle -->
          <div class="resize-handle left"
               (mousedown)="onLoopMouseDown($event, loop, 'resize-left')"
               (keydown.enter)="onLoopMouseDown($event, loop, 'resize-left')"
               (keydown.space)="onLoopMouseDown($event, loop, 'resize-left')"
               tabindex="-1"
               role="button"
               [attr.aria-label]="'Resize loop start - Current start time: ' + formatDuration(loop.startTime) + ' (Shift+Left/Right arrows to resize)'">
          </div>
          
          <!-- Enhanced loop segment body -->
          <div class="loop-body"
               (mousedown)="onLoopMouseDown($event, loop, 'move')"
               [attr.aria-hidden]="true">
            <!-- Visual state indicators -->
            <div class="loop-state-indicators">
              @if (isLoopPlaying(loop)) {
                <div class="state-indicator playing" title="Currently playing">▶</div>
              }
              @if (selectedLoopId === loop.id) {
                <div class="state-indicator selected" title="Selected">✓</div>
              }
              @if (hasLoopCollisionNearby(loop)) {
                <div class="state-indicator collision" title="Near collision">⚠</div>
              }
            </div>
            
            <span class="loop-label" *ngIf="loop.name">{{ loop.name }}</span>
            <div class="loop-times">
              <span class="start-time">{{ formatDuration(loop.startTime) }}</span>
              <span class="duration">{{ formatDuration(loop.endTime - loop.startTime) }}</span>
              <span class="end-time">{{ formatDuration(loop.endTime) }}</span>
            </div>
            
            <!-- Enhanced loop progress indicator for active loop -->
            @if (isLoopPlaying(loop)) {
              <div class="loop-progress" 
                   [style.width.%]="getActiveLoopProgress()"
                   [class.near-end]="getActiveLoopProgress() > 80"
                   aria-hidden="true">
                <div class="progress-glow"></div>
              </div>
            }
          </div>
          
          <!-- Right resize handle -->
          <div class="resize-handle right"
               (mousedown)="onLoopMouseDown($event, loop, 'resize-right')"
               (keydown.enter)="onLoopMouseDown($event, loop, 'resize-right')"
               (keydown.space)="onLoopMouseDown($event, loop, 'resize-right')"
               tabindex="-1"
               role="button"
               [attr.aria-label]="'Resize loop end - Current end time: ' + formatDuration(loop.endTime) + ' (Shift+Left/Right arrows to resize)'">
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Enhanced Timeline Information Display -->
  <div class="timeline-info" *ngIf="isReady">
    <!-- Duration and Active Segment Indicators -->
    <div class="timeline-labels">
      <span class="time-label start">0:00</span>
      <span class="time-label current" 
            [class.seeking]="isSeeking"
            [attr.aria-live]="isSeeking ? 'polite' : 'off'">
        {{ formatDuration(currentTime) }}
      </span>
      <span class="time-label end">{{ formatDuration(duration) }}</span>
    </div>
    
    <!-- Active Segment Information -->
    @if (activeLoopId && useFacade) {
      <div class="active-segment-info"
           [class.looping]="isPlaying"
           [attr.aria-live]="isPlaying ? 'polite' : 'off'">
        @if (getActiveLoopInfo(); as activeLoop) {
          <div class="active-loop-details">
            <span class="loop-name">{{ activeLoop.name || 'Loop ' + activeLoop.id }}</span>
            <span class="loop-progress-text">
              {{ formatDuration(currentTime - activeLoop.startTime) }} / 
              {{ formatDuration(activeLoop.endTime - activeLoop.startTime) }}
            </span>
            <div class="loop-progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getActiveLoopProgress()"></div>
            </div>
          </div>
        }
      </div>
    }
    
    <!-- Timeline Statistics -->
    <div class="timeline-stats">
      <span class="segments-count">{{ effectiveLoops.length }} segment{{ effectiveLoops.length !== 1 ? 's' : '' }}</span>
      @if (getTotalLoopsDuration() > 0) {
        <span class="total-loops-duration">
          {{ formatDuration(getTotalLoopsDuration()) }} looped
        </span>
      }
      @if (selectedLoopId) {
        <span class="selected-indicator">Selected</span>
      }
    </div>
  </div>
  
  <!-- Minimap for Long Videos -->
  @if (shouldShowMinimap()) {
    <div id="timeline-minimap"
         class="timeline-minimap"
         [class.expanded]="isMinimapExpanded"
         (click)="onMinimapClick($event)"
         role="region"
         [attr.aria-label]="'Mini-carte de la timeline avec ' + effectiveLoops.length + ' segments'"
         [attr.aria-hidden]="!isMinimapExpanded">
      <div class="minimap-track">
        <!-- Minimap segments -->
        @for (loop of effectiveLoops; track trackLoopById($index, loop)) {
          <div class="minimap-segment"
               [style.left.%]="getLoopPosition(loop).left"
               [style.width.%]="getLoopPosition(loop).width"
               [style.background-color]="getLoopColor(loop)"
               [class.active]="activeLoopId === loop.id"
               [class.selected]="selectedLoopId === loop.id"
               [attr.title]="loop.name || 'Loop ' + loop.id">
          </div>
        }
        <!-- Minimap current time indicator -->
        <div class="minimap-current-time"
             [style.left.%]="currentTimePercentage"></div>
      </div>
      <button class="minimap-toggle" 
              (click)="toggleMinimap($event)"
              [attr.aria-label]="isMinimapExpanded ? 'Réduire la mini-carte' : 'Agrandir la mini-carte'"
              [attr.aria-expanded]="isMinimapExpanded"
              [attr.aria-controls]="'timeline-minimap'"
              type="button">
        <span aria-hidden="true">{{ isMinimapExpanded ? '▼' : '▲' }}</span>
      </button>
    </div>
  }
  
  <!-- Loading State -->
  @if (isLoading) {
    <div class="timeline-loading" role="status" aria-label="Chargement de la timeline">
      <div class="loading-shimmer" aria-hidden="true"></div>
    </div>
  }
  
  <!-- Screen reader help text -->
  <div id="timeline-help" class="sr-only">
    Timeline interactive : Utilisez les flèches pour naviguer, Entrée pour sélectionner une position. 
    Ctrl+L pour créer une boucle, Delete pour supprimer la boucle sélectionnée. 
    Double-clic pour créer une boucle à la position cliquée.
  </div>
  
  <div id="loop-actions-help" class="sr-only">
    Actions disponibles : Entrée pour lire, Delete pour supprimer, flèches avec Shift pour redimensionner.
  </div>
</div>
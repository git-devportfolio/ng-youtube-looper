<div [class]="getContainerClasses()">
  
  <!-- Timeline Track -->
  <div class="timeline-track"
       [class.creating]="isCreatingLoop"
       [class.has-collision]="creationHasCollision"
       (click)="onTrackClick($event)"
       (dblclick)="onTrackDoubleClick($event)"
       (mousedown)="onTrackMouseDown($event)"
       (keydown)="onKeyDown($event)"
       (touchstart)="onTouchStart($event)"
       (touchend)="onTouchEnd($event)"
       [style.cursor]="isReady ? (isCreatingLoop ? 'grabbing' : canCreateLoops ? 'crosshair' : 'pointer') : 'default'"
       tabindex="0"
       role="slider"
       [attr.aria-valuemin]="0"
       [attr.aria-valuemax]="duration"
       [attr.aria-valuenow]="currentTime"
       [attr.aria-label]="'Timeline scrubber - Current time: ' + formatDuration(currentTime) + ' of ' + formatDuration(duration) + (canCreateLoops ? '. Double-click or drag to create loop, Ctrl+L to create at current time' : '')"
    
    <!-- Background Track -->
    <div class="track-background"></div>
    
    <!-- Current Time Indicator Container -->
    <div class="current-time-indicator-container">
      <!-- Current Time Indicator with enhanced states -->
      <div class="current-time-indicator"
           [class]="indicatorClasses"
           [style.left.%]="currentTimePercentage"
           [attr.aria-label]="'Position: ' + formatDuration(currentTime)">
        <div class="indicator-circle"></div>
        <div class="indicator-line"></div>
      </div>
    </div>
    
    <!-- Loop Creation Preview -->
    @if (creationPreview && getCreationPreviewPosition()) {
      <div class="creation-preview"
           [class.has-collision]="creationHasCollision"
           [style.left.%]="getCreationPreviewPosition()!.left"
           [style.width.%]="getCreationPreviewPosition()!.width"
           [attr.aria-label]="'Creating loop from ' + formatDuration(creationPreview.startTime) + ' to ' + formatDuration(creationPreview.endTime)">
        <div class="preview-body">
          <div class="preview-times">
            <span class="start-time">{{ formatDuration(creationPreview.startTime) }}</span>
            <span class="end-time">{{ formatDuration(creationPreview.endTime) }}</span>
          </div>
          <div class="preview-duration">{{ formatDuration(creationPreview.endTime - creationPreview.startTime) }}</div>
        </div>
        @if (creationHasCollision) {
          <div class="collision-warning">âš </div>
        }
      </div>
    }
    
    <!-- Loop Segments Container -->
    <div class="loop-segments-container">
      @for (loop of effectiveLoops; track loop.id; let i = $index) {
        <div [class]="getLoopClasses(loop)"
             [attr.data-loop-id]="loop.id"
             [style.left.%]="getLoopPosition(loop).left"
             [style.width.%]="getLoopPosition(loop).width"
             [style.--loop-index]="i"
             [style.animation-delay]="getLoopAnimationDelay(i)"
             (click)="onLoopClick($event, loop)"
             (mouseenter)="onLoopMouseEnter(loop)"
             (mouseleave)="onLoopMouseLeave(loop)"
             tabindex="0"
             role="button"
             [attr.aria-pressed]="selectedLoopId === loop.id"
             [attr.aria-label]="'Loop segment' + (loop.name ? ' ' + loop.name : '') + ' from ' + formatDuration(loop.startTime) + ' to ' + formatDuration(loop.endTime)">
          
          <!-- Left resize handle -->
          <div class="resize-handle left"
               (mousedown)="onLoopMouseDown($event, loop, 'resize-left')"
               tabindex="0"
               role="button"
               [attr.aria-label]="'Resize loop start - Current start time: ' + formatDuration(loop.startTime)">
          </div>
          
          <!-- Loop segment body -->
          <div class="loop-body"
               (mousedown)="onLoopMouseDown($event, loop, 'move')"
               [attr.aria-hidden]="true">
            <span class="loop-label" *ngIf="loop.name">{{ loop.name }}</span>
            <div class="loop-times">
              <span class="start-time">{{ formatDuration(loop.startTime) }}</span>
              <span class="end-time">{{ formatDuration(loop.endTime) }}</span>
            </div>
            
            <!-- Loop progress indicator for active loop -->
            @if (isLoopPlaying(loop)) {
              <div class="loop-progress" 
                   [style.width.%]="getActiveLoopProgress()"
                   aria-hidden="true"></div>
            }
          </div>
          
          <!-- Right resize handle -->
          <div class="resize-handle right"
               (mousedown)="onLoopMouseDown($event, loop, 'resize-right')"
               tabindex="0"
               role="button"
               [attr.aria-label]="'Resize loop end - Current end time: ' + formatDuration(loop.endTime)">
          </div>
        </div>
      }
    </div>
  </div>
  
  <!-- Timeline Labels (optional) -->
  <div class="timeline-labels" *ngIf="isReady">
    <span class="time-label start">0:00</span>
    <span class="time-label end">{{ formatDuration(duration) }}</span>
  </div>
  
  <!-- Loading State -->
  @if (isLoading) {
    <div class="timeline-loading">
      <div class="loading-shimmer"></div>
    </div>
  }
</div>